#!/usr/bin/env bash
# Refresh Claude access token using stored refresh token

creds_file="${CLAUDE_CREDENTIALS_FILE:-$HOME/.claude/.credentials.json}"
token_url="https://platform.claude.com/v1/oauth/token"
client_id="${CLAUDE_CLIENT_ID:-9d1c250a-e61b-44d9-88ed-5944d1962f5e}"

refresh_token="${1:-}"

if [[ -z "$refresh_token" ]]; then
  if [[ ! -f "$creds_file" ]]; then
    echo "Error: No credentials file found at $creds_file" >&2
    echo "Provide a refresh token as an argument: claude_refresh_token <token>" >&2
    exit 1
  fi
  refresh_token="$(jq -r '.claudeAiOauth.refreshToken // empty' "$creds_file" 2>/dev/null)"
  if [[ -z "$refresh_token" ]]; then
    echo "Error: No refreshToken found in $creds_file" >&2
    exit 1
  fi
fi

echo "Requesting new access token..." >&2

response="$(curl -sSL -w "\n%{http_code}" -X POST "$token_url" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=refresh_token" \
  -d "refresh_token=${refresh_token}" \
  -d "client_id=${client_id}")"

http_code="$(echo "$response" | tail -n1)"
response="$(echo "$response" | head -n -1)"

if [[ "$http_code" != "200" ]]; then
  echo "Error: Token refresh failed (HTTP $http_code):" >&2
  echo "$response" | jq . >&2 2>/dev/null || echo "$response" >&2
  exit 1
fi

access_token="$(echo "$response" | jq -r '.access_token // empty')"
new_refresh_token="$(echo "$response" | jq -r '.refresh_token // empty')"
expires_in="$(echo "$response" | jq -r '.expires_in // empty')"

if [[ -z "$access_token" ]]; then
  echo "Error: No access_token in response:" >&2
  echo "$response" | jq . >&2
  exit 1
fi

if [[ -f "$creds_file" ]]; then
  expires_at_ms=$(( ($(date +%s) + ${expires_in:-3600}) * 1000 ))
  tmp="$(mktemp)"
  jq \
    --arg at "$access_token" \
    --arg rt "${new_refresh_token:-$refresh_token}" \
    --argjson ea "$expires_at_ms" \
    '.claudeAiOauth.accessToken = $at | .claudeAiOauth.refreshToken = $rt | .claudeAiOauth.expiresAt = $ea' \
    "$creds_file" > "$tmp" && mv "$tmp" "$creds_file"
  echo "Credentials updated at $creds_file" >&2
else
  echo "$access_token"
fi
